version: "3.9"

services:
  # ---------------------------------------------------------
  # FRONTEND (Nginx sirviendo build de Vite)
  # ---------------------------------------------------------
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        VITE_API_URL=/api
    restart: always
    ports:
      - "8080:80" # frontend vía nginx
    depends_on:
      - api

  # ---------------------------------------------------------
  # BACKEND PRINCIPAL (Node.js)
  # ---------------------------------------------------------
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    restart: always

    environment:
      NODE_ENV: production
      PORT: 5000

      # DBs
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/ingenio
      MONGO_URI: mongodb://mongo:27017/ingenio
      REDIS_URL: redis://redis:6379

      # IA
      IA_API: http://ia-service:8000

    # API expone 5000
    ports:
      - "5000:5000"

    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_started

  # ---------------------------------------------------------
  # IA SERVICE (Python)
  # ---------------------------------------------------------
  ia-service:
    build:
      context: ./apps/ia-service
      dockerfile: Dockerfile
    restart: always
    environment:
      SECURE_DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/ingenio
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    deploy:
      resources:
        limits:
          memory: 800M

  # ---------------------------------------------------------
  # POSTGRES (DB principal)
  # ---------------------------------------------------------
  postgres:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ingenio

    volumes:
      - postgres_data_prod:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ingenio"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------
  # MONGO (Logs de sensores, análisis liviano)
  # ---------------------------------------------------------
  mongo:
    image: mongo:7
    restart: always

    volumes:
      - mongo_data_prod:/data/db

    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ---------------------------------------------------------
  # REDIS (Cache y colas internas)
  # ---------------------------------------------------------
  redis:
    image: redis:7
    restart: always
    command: ["redis-server", "--appendonly", "yes"]

    volumes:
      - redis_data_prod:/data

# ---------------------------------------------------------
# VOLUMENES PERSISTENTES
# ---------------------------------------------------------
volumes:
  postgres_data_prod:
  mongo_data_prod:
  redis_data_prod:
