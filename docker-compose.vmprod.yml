services:
  # ---------------------------------------------------------
  # FRONTEND (Nginx sirviendo build. VITE_API_URL=/api)
  # ---------------------------------------------------------
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api
    restart: always
    ports:
      - "8080:80"
    depends_on:
      - api

  # ---------------------------------------------------------
  # BACKEND (Node.js + Prisma en producci√≥n)
  # ---------------------------------------------------------
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    restart: always
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: production
      PORT: 5000

      # Bases de datos internas
      DATABASE_URL: postgresql://postgres:mysecretpassword@postgres:5432/ingenio
      MONGO_URI: mongodb://mongo:27017/ingenio
      REDIS_URL: redis://redis:6379

      # IA service dentro del cluster
      IA_API: http://ia-service:8000

    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_started

  # ---------------------------------------------------------
  # IA SERVICE (Python)
  # ---------------------------------------------------------
  ia-service:
    build:
      context: ./apps/ia-service
      dockerfile: Dockerfile
    restart: always
    environment:
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 800M

  # ---------------------------------------------------------
  # POSTGRES (DB principal)
  # ---------------------------------------------------------
  postgres:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_DB: ingenio
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ingenio"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------
  # MONGO (sensor processing, historiales)
  # ---------------------------------------------------------
  mongo:
    image: mongo:4.4.18
    restart: always
    volumes:
      - mongo_data_prod:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  # ---------------------------------------------------------
  # REDIS (cache + cola)
  # ---------------------------------------------------------
  redis:
    image: redis:7
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data_prod:/data

# ---------------------------------------------------------
# VOLUMES
# ---------------------------------------------------------
volumes:
  postgres_data_prod:
  mongo_data_prod:
  redis_data_prod:
